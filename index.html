<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>没多少像素倍增游戏 - 直播</title>
</head>
<body>
    <span>请输入端口：</span><input type="number" id="port" value="81"></input> 
    <canvas id="gameCanvas"></canvas>
    <div id="stats"></div>

    <script>
        const canvas = document.getElementById('gameCanvas')
        const ctx = canvas.getContext('2d')
        const stats = document.getElementById('stats')
        let lastTimestamp = 0

        setTimeout(() => {
            // 初始化WebSocket
            const ws = new WebSocket('ws://'+ location.hostname + ':' + document.getElementById('port').value)
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data)
                
                // 渲染画面
                if(data.type === 'frame') {
                    const img = new Image()
                    img.onload = () => {
                        canvas.width = img.naturalWidth
                        canvas.height = img.naturalHeight
                        ctx.drawImage(img, 0, 0)
                        
                        // 显示性能统计与画面外游戏信息
                        const latency = Date.now() - data.timestamp * 1000
                        statsHtml = `
                            分辨率: ${canvas.width}x${canvas.height}<br>
                            延迟: ${latency.toFixed(1)}ms<br>
                            客户端帧率: ${(1000 / (Date.now() - lastTimestamp)).toFixed(1)} FPS<br>
                            服务端帧率: ${data.others.server_fps.toFixed(1)} FPS<br>
                            <hr>
                            已运行: ${data.others.tickcnt}帧
                        `
                        if (data.others.into15) {
                            statsHtml += '<br>乱斗模式已开启'
                        }
                        if (data.others.filled != -1) {
                            statsHtml += `<br>已霸屏${(data.others.tickcnt-data.others.filled)}帧`
                        }
                        if (data.others.tickcnt > 3000){
                            statsHtml += '<br>已开始快速结束'
                        }
                        stats.innerHTML = statsHtml
                        lastTimestamp = Date.now()
                    }
                    img.src = `data:image/png;base64,${data.data}`
                }
            }
            // 自动重连
            ws.onclose = () => {
                console.log('WebSocket连接已关闭，尝试重新连接...')
                setTimeout(() => location.reload(), 1000)
            }
        }, 5000)

    </script>

    <style>
        body { margin: 0; background: #1a1a1a; }
        #gameCanvas { box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #stats {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #fff;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            font-family: monospace;
        }
    </style>
</body>
</html>